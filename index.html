<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<title>ecustspace</title>
<link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
<script src="//recaptcha.net/recaptcha/api.js"></script>
<style>
  .card-text {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    -webkit-line-clamp: 5;
  }
</style>
<script>
var id
var mytoken
var currentreplyid
var nowpostid
var nowreplyid
function creatcard(floor,content,time){
	var replycardhtml = `<div class="reply_card">
<div class="reply-header">
    <p class="floor">${floor}楼</p>
  </div>
  <div class="reply-content">
    <p class="card-text text-break fs-5">${content}</p>
    <p class="reply-date text-muted">${time}</p>
  </div>
	<hr> <!-- 加上横线 -->
	</div>`
	var replycard = document.createElement("div");
	replycard.innerHTML=replycardhtml
	document.getElementById("reply").appendChild(replycard);
}

function creatpostcard(postid,content,reply,time){
	var postcardhtml = `<div class="post-card" data-post-id="${postid}">
<div class="card w-100 rounded-0">
<div class="card-body">
<table width="75%">
  <tbody>
    <tr>
      <td width="40%" nowrap>&nbsp;#${postid}</td>
      <td nowrap><img src="svg/72-icons-eleken/SVG/clock1.svg" alt="" width="20" height="20"/>&nbsp;${time}</td>
    </tr>
  </tbody>
</table>
<p class="card-text text-break fs-5">${content}</p>
<img src="svg/72-icons-eleken/SVG/message.svg" alt="" width="20" height="20"/>&nbsp;(${reply})
</div>
</div>
</div>`
	var postcard = document.createElement("div");
	postcard.innerHTML=postcardhtml
	document.getElementById("post-cards-container").appendChild(postcard);
}

	function onSubmit(token){
	$(document).ready(function() {
	var regex = /^[a-zA-Z0-9]{6,18}$/;	
	var formData = new FormData(document.getElementById("myform"));
	var email=formData.get("email");
	var password=formData.get("password");// 获取表单数据
	if(regex.test(email)&&regex.test(password)){
	formData = $('#myform').serialize() + '&tape=2';
    $.ajax({
      url: 'https://43.143.86.109/renjiyanzheng2.php',
      type: 'POST',
      data: formData,
      xhrFields: {
        withCredentials: true // 允许发送凭证信息
    },  
	
      success: function(response) {
	response = response.replace(/^\ufeff/g, ''); // 去除 BOM 字符
  var data = JSON.parse(response);
        if('alert' in data){alert(data.alert)}
		if('token' in data){mytoken = data.token}
		if('id' in data){id = data.id}// 显示响应数据
      },
      error: function(xhr, status, error) {
        console.log(xhr);
		  
      }
    });
	}
	else{alert('email或password不符合格式');}
	grecaptcha.reset(2)
	})
	}

function onSubmit1(token){
	$(document).ready(function() {
	var formdate = $('#postcontent').serialize() + '&sessionid=' + id + '&token=' + mytoken + '&tape=3'
	  $.ajax({
      url: 'https://43.143.86.109/renjiyanzheng2.php',
      type: 'POST',
      data: formdate,
      xhrFields: {
        withCredentials: true // 允许发送凭证信息
    },  
      success: function(response) {
	 
	response = response.replace(/^\ufeff/g, ''); // 去除 BOM 字符
  var data = JSON.parse(response);
        if('alert' in data){alert(data.alert)}
      },
      error: function(xhr, status, error) {
        console.log(xhr);
		  
      }
		  
    });
	
	grecaptcha.reset(3)	
	})
}
	
function onSubmit2(token){
	var data1 = '&g-recaptcha-response=' + token + '&token=' + mytoken + '&sessionid=' + id + '&tape=4'
	 $.ajax({
      url: 'https://43.143.86.109/renjiyanzheng2.php',
      type: 'POST',
      data: data1,
      xhrFields: {
        withCredentials: true // 允许发送凭证信息
    },  
      success: function(response) {
	 
	response = response.replace(/^\ufeff/g, ''); // 去除 BOM 字符
  var data2 = JSON.parse(response);
        if('alert' in data2){alert(data2.alert)}
		if('posts' in data2){
			var posts = data2.posts
			document.getElementById("post-cards-container").innerHTML=``
			$.each(posts, function(index, post) {
				creatpostcard(post.post_id,post.content,post.reply,post.post_time)
				nowpostid = post.post_id
			})
		}
      },
      error: function(xhr, status, error) {
        console.log(xhr);
		  
      }
		  
    });
	grecaptcha.reset()
}
	function refreshreply(){
		var data = '&currentreplyid=' + currentreplyid
			 $.ajax({
      url: 'https://43.143.86.109/replyselect.php',
      type: 'POST',
      data: data,
      xhrFields: {
        withCredentials: true // 允许发送凭证信息
    },  
      success: function(response) {
	 
	response = response.replace(/^\ufeff/g, ''); // 去除 BOM 字符
  var data2 = JSON.parse(response);
        if('alert' in data2){alert(data2.alert)}
		if('replys' in data2){
			var replys = data2.replys
			document.getElementById("reply").innerHTML=``
			$.each(replys, function(index, reply) {
				creatcard(reply.reply_id,reply.content,reply.time)
				nowreplyid = reply.reply_id
			})
			document.getElementById("bodyddd").scrollTop=0
		}
      },
      error: function(xhr, status, error) {
        console.log(xhr);
		  
      }
		  
    });
	}
	
function onSubmit3(token){
	$(document).ready(function() {
	var formdate = $('#replycontent').serialize() + '&sessionid=' + id + '&token=' + mytoken + '&tape=5' + '&currentreplyid=' + currentreplyid 
	  $.ajax({
      url: 'https://43.143.86.109/renjiyanzheng2.php',
      type: 'POST',
      data: formdate,
      xhrFields: {
        withCredentials: true // 允许发送凭证信息
    },  
      success: function(response) {
	 
	response = response.replace(/^\ufeff/g, ''); // 去除 BOM 字符
  var data = JSON.parse(response);
        if('alert' in data){alert(data.alert)}
      },
      error: function(xhr, status, error) {
        console.log(xhr);
		  
      }
		  
    });
	
	grecaptcha.reset(4)	
	})
}
	function onSubmit4(token){
		var data1 = '&g-recaptcha-response=' + token + '&token=' + mytoken + '&sessionid=' + id + '&tape=6' + '&nowpostid=' + nowpostid
	 $.ajax({
      url: 'https://43.143.86.109/renjiyanzheng2.php',
      type: 'POST',
      data: data1,
      xhrFields: {
        withCredentials: true // 允许发送凭证信息
    },  
      success: function(response) {
	 
	response = response.replace(/^\ufeff/g, ''); // 去除 BOM 字符
  var data2 = JSON.parse(response);
        if('alert' in data2){alert(data2.alert)}
		if('posts' in data2){
			var posts = data2.posts
			$.each(posts, function(index, post) {
				creatpostcard(post.post_id,post.content,post.reply,post.post_time)
				nowpostid = post.post_id
			})
		}
      },
      error: function(xhr, status, error) {
        console.log(xhr);
		  
      }
		  
    });
	grecaptcha.reset(1)
	}

	function replyformore(){
		var data = '&nowreplyid=' + nowreplyid + '&currentreplyid=' + currentreplyid
			 $.ajax({
      url: 'https://43.143.86.109/replyformore.php',
      type: 'POST',
      data: data,
      xhrFields: {
        withCredentials: true // 允许发送凭证信息
    },  
      success: function(response) {
	 
	response = response.replace(/^\ufeff/g, ''); // 去除 BOM 字符
  var data2 = JSON.parse(response);
        if('alert' in data2){alert(data2.alert)}
		if('replys' in data2){
			var replys = data2.replys
			$.each(replys, function(index, reply) {
				creatcard(reply.reply_id,reply.content,reply.time)
				nowreplyid = reply.reply_id
			})
			
		}
      },
      error: function(xhr, status, error) {
        console.log(xhr);
		  
      }
		  
    });
	}
</script>
</head>

<body>
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvas" aria-labelledby="offcanvasLabel" data-bs-backdrop="false" data-bs-scroll="true">
<div class="offcanvas-header">

<h4 class="offcanvas-title" id="offcanvasLabel">reply</h4>

<button class="btn btn-light end-0" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal2" id="replybtn">回复</button>
<button type="button" class="btn btn-light" id="replyrefresh">刷新</button>
<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>


</div>
<hr>
<div class="offcanvas-body" id="bodyddd">
<h5 class="card-text text-break" id="postneirong"></h5>
<hr>
<div class="reply_body" id="reply">
<div class="reply_card">
<div class="reply-header">
    <span class="user-name">用户名</span>
  </div>
  <div class="reply-content">
    <p class="card-text text-break">第一个用户的回复内容</p>
    <span class="reply-date">2023-03-21 09:00</span>
  </div>
	<hr> <!-- 加上横线 -->
	</div>
	
 <div class="reply-header">
    <span class="user-name">另一个用户</span>
  </div>
  <div class="reply-content">
    <p class="card-text text-break">另一个用户的回复内容</p>
    <span class="reply-date">2023-03-21 10:00</span>
  </div>
</div>
  <div class="reply-footer">
    <button type="button" class="btn btn-light" id="formore">加载更多</button>
  </div>

</div>
</div>
<div class="container bg-light vh-100">
<nav class="navbar navbar-light bg-light">
<div class="container-fluid">
<a class="navbar-brand" href="#">Navbar</a>
<button class="btn btn-outline-success me-0" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal">登录</button>

</div>
</nav>
<ul class="nav nav-tabs" id="myTab" role="tablist">
<li class="nav-item" role="presentation">
<button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">主页</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">关注</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">漂流瓶</button>
</li>
</ul>
<div class="tab-content" id="myTabContent">
<div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
<!-- 主页内容   -->
<nav class="navbar navbar-light bg-light">
<div class="container-fluid justify-content-end">
<button class="btn btn-outline-success me-2" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal1">发帖</button>
<button class="btn btn-outline-success g-recaptcha" type="button" id="refresh" data-sitekey="6LdFP0AlAAAAAHCFWFdhftLrUsVIvK-ezlwVAlcS" data-callback="onSubmit2">刷新</button>
</div>
</nav>
<div class="container" id="post-cards-container">
<div class="post-card" data-post-id="0">
<div class="col-sm-12 col-md-12">
<div class="card w-100 rounded-0">
<div class="card-body">
<table width="75%">
  <tbody>
    <tr>
      <td width="40%" nowrap>&nbsp;#457</td>
      <td nowrap><img src="svg/72-icons-eleken/SVG/clock1.svg" alt="" width="20" height="20"/>&nbsp;</td>
    </tr>
  </tbody>
</table>
<h5 class="card-text">With supporting text below as a natural lead-in to additional content.</h5>
<img src="svg/72-icons-eleken/SVG/message.svg" alt="" width="20" height="20"/>&nbsp;(455)
</div>
</div>
</div>
</div>
</div>
<div class="container mt-1">
<button class="btn btn-light bg-white g-recaptcha w-100" type="button" id="formorepost" data-sitekey="6LdFP0AlAAAAAHCFWFdhftLrUsVIvK-ezlwVAlcS" data-callback="onSubmit4">加载更多</button>	
	</div>
</div>
<div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">...</div>
<div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">暂未开放</div>
</div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
  <h5 class="modal-title" id="exampleModalLabel">ECUSTSPACE</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="myform">
<div class="modal-body">
 <div class="mb-3">
<label for="exampleInputEmail1" class="form-label">Email address</label>
<div class="input-group mb-3">
<input type="text" class="form-control" name="email" placeholder="你的学号" aria-label="Recipient's username" aria-describedby="basic-addon2">
<span class="input-group-text" id="basic-addon2">@mail.ecust.edu.cn</span>
</div>
</div>
<div class="mb-3">
<label for="exampleInputPassword1" class="form-label">Password</label>
<input type="password" class="form-control" id="exampleInputPassword1" name="password">
</div>		

</div>
<div class="modal-footer">
  <button type="submit" class="btn btn-primary g-recaptcha" data-sitekey="6LdFP0AlAAAAAHCFWFdhftLrUsVIvK-ezlwVAlcS" data-callback="onSubmit" id="denglu">登录
</button>
</div>

</form>
</div>
</div>
</div>

<div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
  <h5 class="modal-title" id="exampleModalLabel1">说点什么</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="postcontent">
<div class="modal-body">
<textarea class="form-control" id="posttext" rows="4" name="posttext"></textarea>

</div>
<div class="modal-footer">
 <button type="submit" class="btn btn-primary g-recaptcha" data-sitekey="6LdFP0AlAAAAAHCFWFdhftLrUsVIvK-ezlwVAlcS" data-callback="onSubmit1" id="postapost">发布
</button>
</div>
</form>
</div>
</div>
</div>

<div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
  <h5 class="modal-title" id="exampleModalLabel2">reply</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="replycontent">
<div class="modal-body">
<textarea class="form-control" id="replytext" rows="4" name="posttext"></textarea>

</div>
<div class="modal-footer">
 <button type="submit" class="btn btn-primary g-recaptcha" data-sitekey="6LdFP0AlAAAAAHCFWFdhftLrUsVIvK-ezlwVAlcS" data-callback="onSubmit3" id="postareply">发布
</button>
</div>
</form>
</div>
</div>
</div>	
	
<div id="response"></div>
<script>
	window.onload=function(){
		document.getElementById("formore").onclick=function(){
			replyformore()
		}
		document.getElementById("replyrefresh").onclick=function(){
			refreshreply()
		}
	}
	
	const postCardsContainer = document.getElementById("post-cards-container");
    const replyCardsContainer = document.getElementById("bodyddd");

postCardsContainer.addEventListener('click', event => {
  const postCard = event.target.closest('.post-card'); 
  if (!postCard) return; // 如果没有找到，则退出
  const postId = postCard.dataset.postId;
  const cardText = postCard.querySelector('.card-text').textContent;
  document.getElementById("postneirong").innerHTML=cardText
  showReplies(postId); 
});

replyCardsContainer.addEventListener('click', event => {
  const replyCard = event.target.closest('.card-text');
  
  if (!replyCard) return; // 如果没有找到，则退出
  if (replyCard.style.webkitLineClamp == 5) {
	  
    replyCard.style.webkitLineClamp = 60;
  } else {
    replyCard.style.webkitLineClamp = 5;
  }
});	

function showReplies(postId) {
  
  currentreplyid = postId;
  $('#offcanvas').offcanvas('show');
  
  refreshreply()  
}	
</script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>

</body>
</html>
